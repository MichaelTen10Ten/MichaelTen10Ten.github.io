<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MathPalm Pro | Hand-Tracked Mental Math</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        :root {
            --primary: #00f2ff;
            --accent: #7000ff;
            --correct: #00ff88;
            --wrong: #ff3e3e;
            --bg: #050505;
            --panel: rgba(20, 20, 25, 0.85);
        }

        body, html {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            font-family: 'Outfit', 'Segoe UI', sans-serif;
            background: var(--bg);
            color: white;
            overflow: hidden;
        }

        /* Video Background */
        #video-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        video { display: none; }
        
        canvas {
            position: absolute;
            width: 100%; height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* Mirror view */
            filter: brightness(0.4) contrast(1.2);
        }

        /* HUD Styling */
        #hud {
            position: absolute;
            inset: 0;
            z-index: 10;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            padding: 30px;
        }

        .stats-bar {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .stat-group {
            background: var(--panel);
            padding: 15px 25px;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
        }

        .stat-label { font-size: 0.8rem; text-transform: uppercase; color: #aaa; letter-spacing: 1px; }
        .stat-value { font-size: 1.8rem; font-weight: 800; display: block; }

        /* Game Zones */
        .zone {
            position: absolute;
            width: 200px;
            height: 150px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .zone.active {
            background: var(--primary);
            border-style: solid;
            box-shadow: 0 0 30px var(--primary);
            transform: scale(1.1);
            color: black;
        }

        /* Position hitboxes with gaps */
        #zone-0 { top: 15%; left: 10%; }   /* TL */
        #zone-1 { top: 15%; right: 10%; }  /* TR */
        #zone-2 { bottom: 15%; left: 10%; } /* BL */
        #zone-3 { bottom: 15%; right: 10%; } /* BR */

        .zone-label { font-size: 3.5rem; font-weight: 900; }

        /* Central Question Area */
        #question-area {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        #question-text {
            font-size: 7rem;
            font-weight: 900;
            margin: 0;
            text-shadow: 0 0 20px rgba(255,255,255,0.5);
        }

        #feedback-text {
            font-size: 2rem;
            font-weight: 700;
            height: 2.5rem;
            text-transform: uppercase;
        }

        /* Overlays */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(20px);
        }

        .menu-card {
            background: var(--panel);
            padding: 40px;
            border-radius: 30px;
            border: 1px solid var(--primary);
            text-align: center;
            max-width: 600px;
        }

        .btn {
            background: none;
            border: 2px solid white;
            color: white;
            padding: 12px 30px;
            margin: 10px;
            font-size: 1.2rem;
            border-radius: 10px;
            cursor: pointer;
            transition: 0.3s;
            width: 100%;
        }

        .btn:hover {
            background: white;
            color: black;
        }

        .btn-primary {
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-primary:hover {
            background: var(--primary);
            color: black;
        }

        .hidden { display: none !important; }

        /* Center Dot (Visualizer) */
        #hand-dot {
            position: absolute;
            width: 20px;
            height: 20px;
            background: var(--primary);
            border-radius: 50%;
            z-index: 1000;
            box-shadow: 0 0 15px var(--primary);
            pointer-events: none;
            transition: transform 0.1s;
        }

        #deadzone-hint {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 150px;
            height: 150px;
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 50%;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.5; }
            100% { transform: scale(1.5); opacity: 0; }
        }
    </style>
</head>
<body>

    <div id="menu-overlay" class="overlay">
        <div class="menu-card">
            <h1 style="font-size: 3rem; margin-bottom: 0;">MATHPALM <span style="color:var(--primary)">PRO</span></h1>
            <p style="color: #888; margin-bottom: 30px;">Use your palm center to navigate and solve.</p>
            
            <div id="level-list">
                <button class="btn btn-primary" onclick="startGame(1)">Lvl 1: Single Digit +/-</button>
                <button class="btn" onclick="startGame(2)">Lvl 2: Double Digit +/-</button>
                <button class="btn" onclick="startGame(3)">Lvl 3: Single Digit ×</button>
                <button class="btn" onclick="startGame(4)">Lvl 4: Double Digit ×</button>
                <button class="btn" onclick="startGame(5)">Lvl 5: Simplify Fractions</button>
                <button class="btn" onclick="startGame(6)">Lvl 6: The Gauntlet (Mixed)</button>
            </div>
        </div>
    </div>

    <div id="countdown-overlay" class="overlay hidden">
        <h1 id="count-num" style="font-size: 15rem;">3</h1>
    </div>

    <div id="result-overlay" class="overlay hidden">
        <div class="menu-card" id="scorecard-area">
            <h2 style="color: var(--primary)">SESSION COMPLETE</h2>
            <div style="display: flex; justify-content: space-around; margin: 30px 0;">
                <div><span class="stat-label">Points</span><br><span class="stat-value" id="res-score">0</span></div>
                <div><span class="stat-label">Accuracy</span><br><span class="stat-value" id="res-acc">0%</span></div>
                <div><span class="stat-label">Correct</span><br><span class="stat-value" id="res-correct">0</span></div>
            </div>
            <button class="btn btn-primary" onclick="location.reload()">MAIN MENU</button>
            <button class="btn" onclick="downloadCapture()">SAVE SCORECARD</button>
        </div>
    </div>

    <div id="video-container">
        <video id="input_video"></video>
        <canvas id="output_canvas"></canvas>
        <div id="hand-dot"></div>
        <div id="deadzone-hint"></div>

        <div id="hud" class="hidden">
            <div class="stats-bar">
                <div class="stat-group">
                    <span class="stat-label">Score</span>
                    <span class="stat-value" id="ui-score">0000</span>
                </div>
                <div class="stat-group" style="text-align: center;">
                    <span class="stat-label">Time Remaining</span>
                    <span class="stat-value" id="ui-timer">60</span>
                </div>
                <div class="stat-group" style="text-align: right;">
                    <span class="stat-label">Accuracy</span>
                    <span class="stat-value" id="ui-accuracy">0%</span>
                </div>
            </div>

            <div id="question-area">
                <div id="feedback-text"></div>
                <h2 id="question-text">Ready?</h2>
            </div>

            <div id="zone-0" class="zone"><span class="zone-label">?</span></div>
            <div id="zone-1" class="zone"><span class="zone-label">?</span></div>
            <div id="zone-2" class="zone"><span class="zone-label">?</span></div>
            <div id="zone-3" class="zone"><span class="zone-label">?</span></div>
        </div>
    </div>

    <script>
        // --- CONFIG & STATE ---
        const API_KEY = "0KPYMRVALYLOGJGT";
        let gameState = {
            active: false,
            score: 0,
            correct: 0,
            attempted: 0,
            timeLeft: 60,
            currentLevel: 1,
            needsReset: true,
            currentAns: null,
            options: []
        };

        const audio = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(freq, type = 'sine', duration = 0.1) {
            const osc = audio.createOscillator();
            const gain = audio.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audio.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.00001, audio.currentTime + duration);
            osc.connect(gain);
            gain.connect(audio.destination);
            osc.start();
            osc.stop(audio.currentTime + duration);
        }

        // --- MATH ENGINE ---
        function generateMath() {
            let a, b, q, ans, lvl = gameState.currentLevel;
            if (lvl === 6) lvl = Math.floor(Math.random() * 5) + 1;

            const r = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

            switch(lvl) {
                case 1: // +/- 1 Digit
                    a = r(1, 9); b = r(1, 9);
                    if (Math.random() > 0.5) { q = `${a} + ${b}`; ans = a + b; }
                    else { if(a < b) [a,b] = [b,a]; q = `${a} - ${b}`; ans = a - b; }
                    break;
                case 2: // +/- 2 Digit
                    a = r(10, 99); b = r(10, 99);
                    if (Math.random() > 0.5) { q = `${a} + ${b}`; ans = a + b; }
                    else { if(a < b) [a,b] = [b,a]; q = `${a} - ${b}`; ans = a - b; }
                    break;
                case 3: // 1 Digit Mult
                    a = r(2, 12); b = r(2, 9); q = `${a} × ${b}`; ans = a * b;
                    break;
                case 4: // 2 Digit Mult
                    a = r(10, 50); b = r(2, 9); q = `${a} × ${b}`; ans = a * b;
                    break;
                case 5: // Fractions
                    let common = r(2, 5); let n = r(1, 5); let d = r(n + 1, 6);
                    q = `${n * common} / ${d * common}`; ans = `${n}/${d}`;
                    break;
            }

            // Generate unique options
            let opts = [ans.toString()];
            while(opts.length < 4) {
                let off = r(-10, 10); if(off === 0) off = 2;
                let wrong = (lvl === 5) ? `${r(1,5)}/${r(6,9)}` : (parseInt(ans) + off).toString();
                if(!opts.includes(wrong) && (lvl === 5 || parseInt(wrong) >= 0)) opts.push(wrong);
            }
            
            gameState.options = opts.sort(() => Math.random() - 0.5);
            gameState.currentAns = ans.toString();
            
            document.getElementById('question-text').innerText = q;
            gameState.options.forEach((opt, i) => {
                document.getElementById(`zone-${i}`).querySelector('.zone-label').innerText = opt;
            });
        }

        // --- GAME LOGIC ---
        function startGame(level) {
            gameState.currentLevel = level;
            document.getElementById('menu-overlay').classList.add('hidden');
            const cd = document.getElementById('countdown-overlay');
            cd.classList.remove('hidden');
            
            let count = 3;
            const timer = setInterval(() => {
                playTone(440, 'square', 0.05);
                document.getElementById('count-num').innerText = count;
                if(count === 0) {
                    clearInterval(timer);
                    cd.classList.add('hidden');
                    initSession();
                }
                count--;
            }, 1000);
        }

        function initSession() {
            gameState.active = true;
            gameState.score = 0;
            gameState.correct = 0;
            gameState.attempted = 0;
            gameState.timeLeft = 60;
            gameState.needsReset = true;
            
            document.getElementById('hud').classList.remove('hidden');
            generateMath();
            
            const gameTimer = setInterval(() => {
                gameState.timeLeft--;
                document.getElementById('ui-timer').innerText = gameState.timeLeft;
                if(gameState.timeLeft <= 0) {
                    clearInterval(gameTimer);
                    endGame();
                }
            }, 1000);
        }

        function handleSelection(index) {
            if(!gameState.active || gameState.needsReset) return;

            const selected = gameState.options[index];
            gameState.attempted++;
            
            if(selected === gameState.currentAns) {
                gameState.correct++;
                gameState.score += 100;
                playTone(880, 'sine', 0.2);
                document.getElementById('feedback-text').innerText = "Correct!";
                document.getElementById('feedback-text').style.color = "var(--correct)";
            } else {
                playTone(150, 'sawtooth', 0.3);
                document.getElementById('feedback-text').innerText = "Wrong!";
                document.getElementById('feedback-text').style.color = "var(--wrong)";
            }

            updateUI();
            gameState.needsReset = true;
            document.getElementById('question-text').innerText = "RETURN TO CENTER";
        }

        function updateUI() {
            document.getElementById('ui-score').innerText = gameState.score.toString().padStart(4, '0');
            const acc = gameState.attempted > 0 ? Math.round((gameState.correct / gameState.attempted) * 100) : 0;
            document.getElementById('ui-accuracy').innerText = acc + "%";
        }

        function endGame() {
            gameState.active = false;
            document.getElementById('hud').classList.add('hidden');
            document.getElementById('result-overlay').classList.remove('hidden');
            
            const acc = gameState.attempted > 0 ? Math.round((gameState.correct / gameState.attempted) * 100) : 0;
            document.getElementById('res-score').innerText = gameState.score;
            document.getElementById('res-acc').innerText = acc + "%";
            document.getElementById('res-correct').innerText = gameState.correct;

            // Upload to ThingSpeak
            fetch(`https://api.thingspeak.com/update?api_key=${API_KEY}&field1=${gameState.currentLevel}&field2=${gameState.score}&field3=${gameState.correct}&field4=${acc}`);
        }

        // --- VISION ENGINE ---
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const dot = document.getElementById('hand-dot');

        function onResults(results) {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                
                // Calculate Palm Centroid (Average of several base points for stability)
                // Points: 0 (wrist), 5 (index base), 17 (pinky base)
                const cx = (landmarks[0].x + landmarks[5].x + landmarks[17].x) / 3;
                const cy = (landmarks[0].y + landmarks[5].y + landmarks[17].y) / 3;

                // Mirror for UI
                const uiX = 1 - cx;
                const uiY = cy;

                // Move visual dot
                dot.style.left = (uiX * 100) + "%";
                dot.style.top = (uiY * 100) + "%";

                if (gameState.active) {
                    // Check Reset Zone (Center Circle)
                    const distFromCenter = Math.sqrt(Math.pow(uiX - 0.5, 2) + Math.pow(uiY - 0.5, 2));
                    
                    if (gameState.needsReset) {
                        if (distFromCenter < 0.12) {
                            gameState.needsReset = false;
                            document.getElementById('feedback-text').innerText = "";
                            generateMath();
                        }
                    } else {
                        // Hitbox Detection (Smaller, tighter boxes)
                        // TL: x < 0.3, y < 0.35
                        // TR: x > 0.7, y < 0.35
                        // BL: x < 0.3, y > 0.65
                        // BR: x > 0.7, y > 0.65
                        
                        let zoneIdx = -1;
                        if (uiX < 0.3 && uiY < 0.35) zoneIdx = 0;
                        else if (uiX > 0.7 && uiY < 0.35) zoneIdx = 1;
                        else if (uiX < 0.3 && uiY > 0.65) zoneIdx = 2;
                        else if (uiX > 0.7 && uiY > 0.65) zoneIdx = 3;

                        // Visual feedback for zones
                        document.querySelectorAll('.zone').forEach((z, i) => {
                            if(i === zoneIdx) z.classList.add('active');
                            else z.classList.remove('active');
                        });

                        if (zoneIdx !== -1) handleSelection(zoneIdx);
                    }
                }
            }
            canvasCtx.restore();
        }

        const hands = new Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.8,
            minTrackingConfidence: 0.8
        });
        hands.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => { await hands.send({ image: videoElement }); },
            width: 1280, height: 720
        });
        camera.start();

        function downloadCapture() {
            html2canvas(document.getElementById('scorecard-area')).then(canvas => {
                const link = document.createElement('a');
                link.download = 'MathPalm_Scorecard.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        }
    </script>
</body>
</html>