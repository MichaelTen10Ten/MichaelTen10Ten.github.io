<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MathPalm Pro | Hand-Tracked Arithmetic</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --neon-blue: #00f2ff;
            --neon-pink: #ff007a;
            --neon-green: #00ff88;
            --glass: rgba(255, 255, 255, 0.1);
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: 'Outfit', 'Segoe UI', sans-serif;
            background: #050505;
            color: white;
            overflow: hidden;
        }

        /* Video & Canvas */
        #video-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        video { display: none; }
        
        canvas {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* Mirror effect */
            filter: brightness(0.4) contrast(1.2);
        }

        /* Overlay Systems */
        .overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.4s;
        }

        .hidden { display: none !important; opacity: 0; }

        /* UI Elements */
        #game-ui {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 10;
        }

        .stat-bar {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            pointer-events: none;
        }

        .pill {
            background: var(--glass);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 10px 25px;
            border-radius: 100px;
            backdrop-filter: blur(5px);
            font-weight: 800;
            font-size: 1.2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        /* Target Zones */
        .zone {
            position: absolute;
            width: 250px;
            height: 180px;
            border: 3px dashed rgba(255,255,255,0.2);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            font-weight: 900;
            transition: all 0.3s;
        }

        .zone.active { border-color: var(--neon-blue); background: rgba(0, 242, 255, 0.1); transform: scale(1.05); }
        
        /* Adjusted Positions with Gaps */
        #zone-0 { top: 15%; left: 10%; color: var(--neon-pink); }
        #zone-1 { top: 15%; right: 10%; color: var(--neon-blue); }
        #zone-2 { bottom: 15%; left: 10%; color: var(--neon-green); }
        #zone-3 { bottom: 15%; right: 10%; color: #ffcc00; }

        .neutral-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: rgba(255,255,255,0.5);
        }

        #question-display {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 8rem;
            font-weight: 900;
            text-shadow: 0 0 30px rgba(255,255,255,0.5);
        }

        #feedback-text {
            position: absolute;
            top: 58%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 2.5rem;
            font-weight: 700;
            height: 3rem;
        }

        /* Buttons & Levels */
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 30px; }
        
        button {
            background: transparent;
            color: white;
            border: 2px solid white;
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            border-radius: 10px;
            transition: 0.3s;
        }

        button:hover { background: white; color: black; transform: translateY(-3px); }

        /* Fever & Freeze Effects */
        @keyframes fever {
            0% { box-shadow: inset 0 0 100px var(--neon-pink); }
            50% { box-shadow: inset 0 0 150px var(--neon-blue); }
            100% { box-shadow: inset 0 0 100px var(--neon-pink); }
        }
        .fever-mode #video-container { animation: fever 1.5s infinite; }
        .time-frozen { color: var(--neon-blue); text-shadow: 0 0 20px var(--neon-blue); }

        /* Scorecard (Hidden) */
        #scorecard-render {
            position: fixed;
            left: -2000px;
            width: 600px;
            background: linear-gradient(135deg, #050505, #1a1a1a);
            padding: 40px;
            border: 5px solid var(--neon-blue);
            text-align: center;
        }
    </style>
</head>
<body>

    <div id="menu-overlay" class="overlay">
        <h1 style="font-size: 5rem; margin-bottom: 0; letter-spacing: 10px;">MATH<span style="color:var(--neon-blue)">PALM</span></h1>
        <p style="color: #888; margin-bottom: 30px;">AI GESTURE-BASED ARITHMETIC REACTION GAME</p>
        
        <div class="btn-group">
            <button onclick="startGame(1)">Lvl 1: Simple +/-</button>
            <button onclick="startGame(2)">Lvl 2: Double +/-</button>
            <button onclick="startGame(3)">Lvl 3: Times Tables</button>
            <button onclick="startGame(4)">Lvl 4: Fractions</button>
            <button onclick="startGame(5)">Lvl 5: Triple +/-</button>
            <button onclick="startGame(6)">Lvl 6: Pro Mix</button>
        </div>
    </div>

    <div id="countdown-overlay" class="overlay hidden">
        <div id="count-num" style="font-size: 15rem; font-weight: 900; color: var(--neon-blue);">3</div>
    </div>

    <div id="result-overlay" class="overlay hidden">
        <h1 style="font-size: 3.5rem;">MISSION COMPLETE</h1>
        <div id="final-stats" style="font-size: 1.8rem; margin: 20px 0; line-height: 1.6;"></div>
        <div style="display: flex; gap: 15px;">
            <button onclick="location.reload()">MAIN MENU</button>
            <button onclick="downloadScorecard()" style="border-color: var(--neon-green);">DOWNLOAD SCORECARD</button>
        </div>
    </div>

    <div id="video-container">
        <video id="input_video"></video>
        <canvas id="output_canvas"></canvas>

        <div id="game-ui" class="hidden">
            <div class="stat-bar">
                <div class="pill">SCORE: <span id="ui-score">0</span></div>
                <div class="pill">STREAK: <span id="ui-streak">0</span></div>
                <div class="pill" id="ui-timer-pill">TIME: <span id="ui-timer">60</span>s</div>
                <div class="pill" style="color:var(--neon-blue)">x<span id="ui-mult">1</span></div>
            </div>

            <div id="question-display">--</div>
            <div id="feedback-text"></div>

            <div id="zone-0" class="zone">?</div>
            <div id="zone-1" class="zone">?</div>
            <div id="zone-2" class="zone">?</div>
            <div id="zone-3" class="zone">?</div>

            <div class="neutral-indicator" id="neutral-node">CENTER HAND</div>
        </div>
    </div>

    <div id="scorecard-render">
        <h1 style="color:var(--neon-blue)">MATHPALM PRO RESULTS</h1>
        <hr style="border: 1px solid #333">
        <h2 id="sc-level">Level: 1</h2>
        <h1 id="sc-score" style="font-size: 4rem; margin: 10px 0;">0000</h1>
        <p id="sc-acc" style="font-size: 1.5rem;">Accuracy: 0%</p>
        <p style="color: #666; margin-top: 20px;">Analyzed by MediaPipe AI</p>
    </div>

    <script>
        // --- CONFIG & STATE ---
        const config = {
            thingspeakKey: "0KPYMRVALYLOGJGT",
            gameDuration: 60,
            deadzoneSize: 0.15, // Center gap percentage
            feverThreshold: 4
        };

        let state = {
            active: false,
            score: 0,
            streak: 0,
            multiplier: 1,
            timeLeft: 60,
            correctAnswers: 0,
            totalAttempts: 0,
            currentLevel: 1,
            needsNeutral: false,
            answerHistory: [],
            isFrozen: false,
            currentAns: ""
        };

        // --- AUDIO ENGINE ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function beep(freq, duration, type = 'sine') {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        // --- MATH LOGIC ---
        function generateQuestion() {
            const r = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
            let a, b, q, ans;

            switch(state.currentLevel) {
                case 1: a = r(1, 15); b = r(1, 15); ans = a + b; q = `${a}+${b}`; break;
                case 2: a = r(20, 99); b = r(10, 50); ans = a - b; q = `${a}-${b}`; break;
                case 3: a = r(2, 12); b = r(2, 12); ans = a * b; q = `${a}×${b}`; break;
                case 4: let c = r(2, 5), fa = r(1, 4), fb = r(fa + 1, 6); q = `${fa*c}/${fb*c}`; ans = `${fa}/${fb}`; break;
                case 5: a = r(100, 500); b = r(100, 500); ans = a + b; q = `${a}+${b}`; break;
                case 6: a = r(12, 30); b = r(3, 9); ans = a * b; q = `${a}×${b}`; break;
            }

            state.currentAns = ans.toString();
            let options = [state.currentAns];
            while(options.length < 4) {
                let off = r(-10, 10);
                let w = (state.currentLevel === 4) ? `${r(1,5)}/${r(2,6)}` : (parseInt(ans) + (off === 0 ? 5 : off)).toString();
                if(!options.includes(w)) options.push(w);
            }
            options.sort(() => Math.random() - 0.5);

            document.getElementById('question-display').innerText = q;
            options.forEach((opt, i) => {
                const z = document.getElementById(`zone-${i}`);
                z.innerText = opt;
                z.dataset.val = opt;
                z.classList.remove('active');
            });
            
            state.needsNeutral = false;
            document.getElementById('feedback-text').innerText = "";
            document.getElementById('neutral-node').style.borderColor = "rgba(255,255,255,0.1)";
        }

        // --- HAND TRACKING LOGIC ---
        function getPalmCenter(landmarks) {
            // Average of Wrist(0), Index_mcp(5), Middle_mcp(9), Ring_mcp(13), Pinky_mcp(17)
            const indices = [0, 5, 9, 13, 17];
            let x = 0, y = 0;
            indices.forEach(i => {
                x += landmarks[i].x;
                y += landmarks[i].y;
            });
            return { x: x / 5, y: y / 5 };
        }

        function onResults(results) {
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const hand = results.multiHandLandmarks[0];
                const center = getPalmCenter(hand);
                
                // Draw Tracking Point
                canvasCtx.fillStyle = state.needsNeutral ? "white" : "cyan";
                canvasCtx.beginPath();
                canvasCtx.arc(center.x * canvasElement.width, center.y * canvasElement.height, 15, 0, 2 * Math.PI);
                canvasCtx.fill();

                if (state.active) {
                    processInput(center.x, center.y);
                }
            }
            canvasCtx.restore();
        }

        function processInput(x, y) {
            // Mirror logic: 0 is left, 1 is right in raw MP, but mirror display flips it.
            // We use raw: TopLeft(>0.7, <0.4), TopRight(<0.3, <0.4), etc.
            
            const inCenterX = x > 0.4 && x < 0.6;
            const inCenterY = y > 0.4 && y < 0.6;

            if (state.needsNeutral) {
                if (inCenterX && inCenterY) {
                    state.needsNeutral = false;
                    generateQuestion();
                }
                return;
            }

            let selectedZone = -1;
            // Top Left
            if (x > 0.65 && y < 0.4) selectedZone = 0;
            // Top Right
            else if (x < 0.35 && y < 0.4) selectedZone = 1;
            // Bottom Left
            else if (x > 0.65 && y > 0.6) selectedZone = 2;
            // Bottom Right
            else if (x < 0.35 && y > 0.6) selectedZone = 3;

            if (selectedZone !== -1) {
                handleSelection(selectedZone);
            }
        }

        function handleSelection(index) {
            const zone = document.getElementById(`zone-${index}`);
            const val = zone.dataset.val;
            state.totalAttempts++;

            if (val === state.currentAns) {
                state.score += (10 * state.multiplier);
                state.streak++;
                state.correctAnswers++;
                
                // Multiplier Logic (3 correct in 5s)
                const now = Date.now();
                state.answerHistory.push(now);
                state.answerHistory = state.answerHistory.filter(t => now - t < 5000);
                state.multiplier = Math.max(1, state.answerHistory.length - 1);

                document.getElementById('feedback-text').innerText = state.multiplier > 1 ? `COMBO x${state.multiplier}!` : "CORRECT";
                document.getElementById('feedback-text').style.color = "var(--neon-green)";
                beep(800 + (state.multiplier * 100), 0.2);

                if (state.streak % 10 === 0) triggerFreeze();
            } else {
                state.streak = 0;
                state.multiplier = 1;
                state.answerHistory = [];
                document.getElementById('feedback-text').innerText = "WRONG";
                document.getElementById('feedback-text').style.color = "var(--neon-pink)";
                beep(150, 0.3, 'sawtooth');
            }

            // UI Refresh
            document.getElementById('ui-score').innerText = state.score;
            document.getElementById('ui-streak').innerText = state.streak;
            document.getElementById('ui-mult').innerText = state.multiplier;
            document.body.classList.toggle('fever-mode', state.multiplier >= config.feverThreshold);
            
            state.needsNeutral = true;
            document.getElementById('neutral-node').style.borderColor = "var(--neon-blue)";
            zone.classList.add('active');
        }

        // --- GAME FLOW ---
        function startGame(level) {
            state.currentLevel = level;
            document.getElementById('menu-overlay').classList.add('hidden');
            document.getElementById('countdown-overlay').classList.remove('hidden');
            
            let count = 3;
            const timer = setInterval(() => {
                beep(400, 0.1);
                document.getElementById('count-num').innerText = count;
                if (count <= 0) {
                    clearInterval(timer);
                    document.getElementById('countdown-overlay').classList.add('hidden');
                    initGameSession();
                }
                count--;
            }, 1000);
        }

        function initGameSession() {
            state.score = 0;
            state.timeLeft = config.gameDuration;
            state.active = true;
            state.streak = 0;
            state.correctAnswers = 0;
            state.totalAttempts = 0;
            
            document.getElementById('game-ui').classList.remove('hidden');
            generateQuestion();

            const clock = setInterval(() => {
                if (!state.isFrozen) {
                    state.timeLeft--;
                    document.getElementById('ui-timer').innerText = state.timeLeft;
                    if (state.timeLeft <= 0) {
                        clearInterval(clock);
                        endGame();
                    }
                }
            }, 1000);
        }

        function triggerFreeze() {
            state.isFrozen = true;
            beep(1000, 0.5, 'square');
            document.getElementById('ui-timer-pill').classList.add('time-frozen');
            setTimeout(() => {
                state.isFrozen = false;
                document.getElementById('ui-timer-pill').classList.remove('time-frozen');
            }, 5000);
        }

        function endGame() {
            state.active = false;
            document.getElementById('game-ui').classList.add('hidden');
            document.getElementById('result-overlay').classList.remove('hidden');
            
            const acc = state.totalAttempts > 0 ? Math.round((state.correctAnswers / state.totalAttempts) * 100) : 0;
            document.getElementById('final-stats').innerHTML = `
                Score: ${state.score}<br>
                Accuracy: ${acc}%<br>
                Correct: ${state.correctAnswers} / ${state.totalAttempts}
            `;

            // Prepare scorecard
            document.getElementById('sc-level').innerText = `Level: ${state.currentLevel}`;
            document.getElementById('sc-score').innerText = state.score;
            document.getElementById('sc-acc').innerText = `Accuracy: ${acc}%`;

            uploadToThingSpeak(state.currentLevel, state.score, state.correctAnswers, acc);
        }

        function uploadToThingSpeak(l, s, c, a) {
            const url = `https://api.thingspeak.com/update?api_key=${config.thingspeakKey}&field1=${l}&field2=${s}&field3=${c}&field4=${a}`;
            fetch(url).then(() => console.log("Logged to Cloud")).catch(e => console.error(e));
        }

        function downloadScorecard() {
            html2canvas(document.getElementById('scorecard-render')).then(canvas => {
                const link = document.createElement('a');
                link.download = `MathPalm_Score_${state.score}.png`;
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        // --- MEDIA PIPE INIT ---
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
        
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.7, minTrackingConfidence: 0.7 });
        hands.onResults(onResults);

        const camera = new Camera(videoElement, {
            onFrame: async () => { await hands.send({ image: videoElement }); },
            width: 1280, height: 720
        });
        camera.start();
    </script>
</body>
</html>