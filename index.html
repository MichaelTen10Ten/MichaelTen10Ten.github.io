<!DOCTYPE html>
<html>

<head>
  <title>Origin Maker</title>
  <script src="https://unpkg.com/blockly/blockly.min.js"></script>
  <style>
    #container {
      display: flex;
      /* Use flexbox for layout */
    }

    #blocklyDiv {
      height: 900px;
      width: 1000px;
      flex: 1;
      /* Allow Blockly to take up available space */
    }

    #outputAreaContainer {
      flex: 1;
      /* Allow output area to take up available space */
      padding: 10px;
      /* Add some padding */
    }

    #outputArea {
      width: 600px;
      height: 600px;
      /* Adjust height as needed */
    }
  </style>
</head>

<body>
  <div id="container">
    <div id="blocklyDiv"></div>
    <div id="outputAreaContainer">
      <textarea id="outputArea" rows="4" cols="50" readonly></textarea>
      <button onclick="copyOutput()">Copy</button>
    </div>
  </div>

  <script>

    function randomnumber() {
      let min = 200;
      let max = 350;
      // Check if the inputs are valid numbers and if min is less than or equal to max.
      if (typeof min !== 'number' || typeof max !== 'number' || min > max) {
        return "Invalid input. Please provide numbers where min <= max.";
      }

      // Generate a random number between 0 (inclusive) and 1 (exclusive).
      const randomNumber = Math.random();

      // Scale and shift the random number to the desired range.
      const randomNumberInRange = Math.floor(randomNumber * (max - min + 1)) + min;

      return randomNumberInRange;
    }

    //POWER
    Blockly.Blocks['multiple'] = {
      init: function () {
        this.appendDummyInput()
          .appendField("Power(Multiple)")
        this.appendDummyInput()
          .appendField("Name:")
          .appendField(new Blockly.FieldTextInput("NAME"), "NAME") // Name input
        this.appendDummyInput()
          .appendField("Description:")
          .appendField(new Blockly.FieldTextInput("DESCRIPTION"), "DESCRIPTION") // Name input
        this.appendStatementInput("POWER")
          .setCheck(null)
          .appendField("Powers:")
        this.setNextStatement(true, null);
        this.setColour(randomnumber());
        this.setDeletable(false);
      }
    };
    Blockly.Blocks['attribute_modify_transfer'] = {
      init: function () {
        this.appendDummyInput()
          .appendField("Power(Attribute Modify Transfer)")
        this.appendDummyInput()
          .appendField("Power Name:")
          .appendField(new Blockly.FieldTextInput("attribute_modify_transfer"), "NAME") // Name input
        this.appendDummyInput()
          .appendField("Class:")
          .appendField(new Blockly.FieldDropdown([
            ["modify_air_speed", "modify_air_speed"],
            ["modify_break_speed", "modify_break_speed"],
            ["modify_crafting", "modify_crafting"],
            ["modify_damage_dealt", "modify_damage_dealt"],
            ["modify_damage_taken", "modify_damage_taken"],
            ["modify_exhaustion", "modify_exhaustion"],
            ["modify_xp_gain", "modify_xp_gain"],
            ["modify_jump", "modify_jump"],
            ["modify_lava_speed", "modify_lava_speed"],
            ["modify_projectile_damage", "modify_projectile_damage"],
            ["modify_slipperiness", "modify_slipperiness"],
            ["modify_status_effect_amplifier", "modify_status_effect_amplifier"],
            ["modify_status_effect_duration", "modify_status_effect_duration"],
            ["modify_swim_speed", "modify_swim_speed"]
          ]), "CLASS") // Name input
        this.appendDummyInput()
          .appendField("Attribute:")
          .appendField(new Blockly.FieldTextInput("minecraft:generic.movement_speed"), "ATTRIBUTE") // Name input
        this.appendDummyInput()
          .appendField("Multiplier:")
          .appendField(new Blockly.FieldNumber(1.25), "MULTIPLIER") // Name input
        this.appendStatementInput("CONDITIONS")
          .setCheck(null)
          .appendField("Condition:")
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(randomnumber());
      }
    };
    Blockly.Blocks['attribute'] = {
      init: function () {
        this.appendDummyInput()
          .appendField("Power(Attribute)")
        this.appendDummyInput()
          .appendField("Power Name:")
          .appendField(new Blockly.FieldTextInput("attribute"), "NAME") // Name input
        this.appendStatementInput("MODIFIERS")
          .setCheck(null)
          .appendField("modifiers:")
        this.appendDummyInput()
          .appendField("update_health:")
          .appendField(new Blockly.FieldDropdown([["true", "true"], ["false", "false"]]), "UPDATE_HEALTH") // Name input
        this.appendStatementInput("CONDITIONS")
          .setCheck(null)
          .appendField("Condition:")
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(randomnumber());
      }
    };


    //DATA
    Blockly.Blocks['string'] = {
      init: function () {
        this.appendDummyInput()
          .appendField("String:")
          .appendField(new Blockly.FieldTextInput("Enter text here"), "TEXT");
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(randomnumber());
      }
    };

    Blockly.Blocks['boolean'] = {
      init: function () {
        this.appendDummyInput()
          .appendField("Boolean:")
          .appendField(new Blockly.FieldDropdown([["true", "true"], ["false", "false"]]), "BOOL");
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(randomnumber());
      }
    };

    Blockly.Blocks['number'] = {
      init: function () {
        this.appendDummyInput()
          .appendField("Int/Float:")
          .appendField(new Blockly.FieldNumber(0), "NUMBER"); // Use FieldNumber
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(randomnumber()); // Example color
      }
    };

    Blockly.Blocks['array'] = {
      init: function () {
        this.appendDummyInput()
          .appendField("Array:")
        this.appendStatementInput("ITEMS")
          .setCheck(null)
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(randomnumber());
      }
    };

    Blockly.Blocks['attributed_attribute_modifier'] = {
      init: function () {
        this.appendDummyInput()
          .appendField("Power(Attributed Attribute Modifier)")
        this.appendDummyInput()
          .appendField("Operation:")
          .appendField(new Blockly.FieldDropdown([["addition", "addition"], ["multiply_base", "multiply_base"], ["multiply_total", "multiply_total"]]), "OPERATION")
        this.appendDummyInput()
          .appendField("Attribute:")
          .appendField(new Blockly.FieldTextInput("minecraft:generic.movement_speed"), "ATTRIBUTE")
        this.appendDummyInput()
          .appendField("Value:")
          .appendField(new Blockly.FieldNumber(9), "VALUE")
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(randomnumber());
      }
    };

    //CONDITIONS
    Blockly.Blocks['conditions_and'] = {
      init: function () {
        this.appendDummyInput()
          .appendField("Conditions(And):")
        this.appendStatementInput("ITEMS")
          .setCheck(null)
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(randomnumber());
      }
    };
    Blockly.Blocks['conditions_or'] = {
      init: function () {
        this.appendDummyInput()
          .appendField("Conditions(Or):")
        this.appendStatementInput("ITEMS")
          .setCheck(null)
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(randomnumber());
      }
    };
    Blockly.Blocks['conditions_ability'] = {
      init: function () {
        this.appendDummyInput()
          .appendField("Conditions(Ability):")
        this.appendDummyInput()
          .appendField("Ability:")
          .appendField(new Blockly.FieldDropdown([
            ["minecraft:flying", "minecraft:flying"],
            ["minecraft:instabuild", "minecraft:instabuild"],
            ["minecraft:invulnerable", "minecraft:invulnerable"],
            ["minecraft:mayBuild", "minecraft:mayBuild"],
            ["minecraft:mayfly", "minecraft:mayfly"]
          ]), "ABILITY")
        this.setPreviousStatement(true, null);
        this.setNextStatement(true, null);
        this.setColour(randomnumber());
      }
    };

    //CONTAINER
    var workspace = Blockly.inject('blocklyDiv', {
      toolbox: `
      <xml id="toolbox" style="display: none;">
        <category name="Power Types" colour="${randomnumber()}">
          <category name="Regular types" colour="${randomnumber()}">
            <block type="attribute_modify_transfer"></block>
            <block type="attribute"></block>
          </category>
          <category name="Action-related" colour="${randomnumber()}">
            
          </category>
          <category name="Modifying types" colour="${randomnumber()}">
            
          </category>
          <category name="Preventing types" colour="${randomnumber()}">
            
          </category>
        </category>
        <category name="Conditions" colour="${randomnumber()}">
          <category name="Meta Condition Types" colour="${randomnumber()}">
            <block type="conditions_and"></block>
            <block type="conditions_or"></block>
          </category>
          <category name="Entity Condition Types" colour="${randomnumber()}">
            <block type="conditions_ability"></block>
          </category>
          <category name="Bi-entity Condition Types" colour="${randomnumber()}">
            
          </category>
          <category name="Biome Condition Types" colour="${randomnumber()}">
            
          </category>
          <category name="Block Condition Types" colour="${randomnumber()}">
            
          </category>
          <category name="Damage Condition Types" colour="${randomnumber()}">
            
          </category>
          <category name="Fluid Condition Types" colour="${randomnumber()}">
            
          </category>
          <category name="Item Condition Types" colour="${randomnumber()}">
            
          </category>
        </category>
        <category name="Data Types" colour="${randomnumber()}">
          <block type="attributed_attribute_modifier"></block>
        </category>
      </xml>`,
    });

    //FUNCTIONS
    function placeInitialContainer() {
      var containerBlock = workspace.newBlock('multiple');
      containerBlock.initSvg();
      containerBlock.render();
    }

    window.addEventListener('load', placeInitialContainer);

    function updateOutput() {
      let topBlock = workspace.getTopBlocks(true)[0];

      function buildOutput(block) {
        let output = "";
        let POWERoutput = "";
        let CONDITIONSoutput = "";
        while (block) {
          if (block.type === 'string') {
            output += `"${block.getFieldValue('TEXT')}" `;
          }
          else if (block.type === 'boolean') {
            output += block.getFieldValue('BOOL') + " ";
          }
          else if (block.type === 'number') {
            output += block.getFieldValue('NUMBER') + " ";
          }
          else if (block.type === 'array') {
            let containerpower = block.getInputTargetBlock('ITEMS');
            output += `[${buildOutput(containerpower)}] `;
          }
          //CONDITION
          else if (block.type === 'conditions_and') {
            let containerpower = block.getInputTargetBlock('ITEMS');
            let items = buildOutput(containerpower);
            if (items) {
              if (items) {
                items = items.split(`}{`).filter(item => item !== "").join(`},{`);
              }
              output += `{"type": "origins:and","conditions": [${items}]}`;
            } else { output += `{"type": "origins:and","conditions": []}`; }
          }
          else if (block.type === 'conditions_or') {
            let containerpower = block.getInputTargetBlock('ITEMS');
            let items = buildOutput(containerpower);
            if (items) {
              if (items) {
                items = items.split(`}{`).filter(item => item !== "").join(`},{`);
              }
              output += `{"type": "origins:or","conditions": [${items}]}`;
            } else { output += `{"type": "origins:or","conditions": []}`; }
          }
          else if (block.type === 'conditions_ability') {
            let ABILITY = block.getFieldValue('ABILITY');
            if (ABILITY) { ABILITY = `,"ability": "` + ABILITY + `"`; } else { ABILITY = "" }
            output += `{"type": "origins:ability"${ABILITY}}`;
          }
          //DATA
          else if (block.type === 'attributed_attribute_modifier') {
            let OPERATION = block.getFieldValue('OPERATION');
            if (OPERATION) { OPERATION = `"operation": "` + OPERATION + `"`; } else { OPERATION = "" }
            let ATTRIBUTE = block.getFieldValue('ATTRIBUTE');
            if (ATTRIBUTE) { ATTRIBUTE = `,"attribute": "` + ATTRIBUTE + `"`; } else { ATTRIBUTE = "" }
            let VALUE = block.getFieldValue('VALUE');
            if (VALUE) { VALUE = `,"value": ` + VALUE + ``; } else { VALUE = "" }
            output += `{${OPERATION}${ATTRIBUTE}${VALUE}}`;
          }
          //POWER
          else if (block.type === 'multiple') {
            let NAME = block.getFieldValue('NAME');
            if (NAME) { NAME = `,"name": "` + NAME + `"`; } else { NAME = "" }
            let DESCRIPTION = block.getFieldValue('DESCRIPTION');
            if (DESCRIPTION) { DESCRIPTION = `,"description": "` + DESCRIPTION + `"`; } else { DESCRIPTION = "" }
            let POWER = block.getInputTargetBlock('POWER');
            POWERoutput = buildOutput(POWER);
            if (POWERoutput) {
              //console.log(POWERoutput)
              POWERoutput = POWERoutput.split(`}"`).filter(item => item !== "").join(`},"`);
              //console.log(POWERoutput)
            }
            output += `{"type": "origins:multiple"${NAME}${DESCRIPTION}, ${POWERoutput}}`;
          }

          else if (block.type === 'attribute_modify_transfer') {
            let NAME = block.getFieldValue('NAME');
            if (NAME == null) { NAME = `youneedaname`; }
            let CLASS = block.getFieldValue('CLASS');
            if (CLASS) { CLASS = `,"class": "` + CLASS + `"`; } else { CLASS = "" }
            let ATTRIBUTE = block.getFieldValue('ATTRIBUTE');
            if (ATTRIBUTE) { ATTRIBUTE = `,"attribute": "` + ATTRIBUTE + `"`; } else { ATTRIBUTE = "" }
            let MULTIPLIER = block.getFieldValue('MULTIPLIER');
            if (MULTIPLIER) { MULTIPLIER = `,"multiplier": "` + MULTIPLIER + `"`; } else { MULTIPLIER = "" }
            let CONDITIONS = block.getInputTargetBlock('CONDITIONS');
            if (CONDITIONS) {
              CONDITIONS = buildOutput(CONDITIONS);
              if (CONDITIONS) {
                CONDITIONS = CONDITIONS.split(`}"`).filter(item => item !== "").join(`},"`);
              }
              CONDITIONS = `,"condition": ` + CONDITIONS + ``;
            } else { CONDITIONS = "" }
            output += `"${NAME}":{"type": "origins:attribute_modify_transfer"${CLASS}${ATTRIBUTE}${MULTIPLIER}${CONDITIONS}}`; // Include name and description
          }

          else if (block.type === 'attribute') {
            let NAME = block.getFieldValue('NAME');
            if (NAME == null) { NAME = `youneedaname`; }
            let UPDATE_HEALTH = block.getFieldValue('UPDATE_HEALTH');
            if (UPDATE_HEALTH) { UPDATE_HEALTH = `,"update_health":"` + UPDATE_HEALTH + `"`; } else { UPDATE_HEALTH = "" }
            let MODIFIERS = block.getInputTargetBlock('MODIFIERS');
            if (MODIFIERS) {
              MODIFIERS = buildOutput(MODIFIERS);
              if (MODIFIERS) {
                MODIFIERS = MODIFIERS.split(`}"`).filter(item => item !== "").join(`},"`);
              }
              MODIFIERS = `,"modifiers": [` + MODIFIERS + `]`;
            } else { MODIFIERS = "" }
            let CONDITIONS = block.getInputTargetBlock('CONDITIONS');
            if (CONDITIONS) {
              CONDITIONS = buildOutput(CONDITIONS);
              if (CONDITIONS) {
                CONDITIONS = CONDITIONS.split(`}"`).filter(item => item !== "").join(`},"`);
              }
              CONDITIONS = `,"condition": ` + CONDITIONS + ``;
            } else { CONDITIONS = "" }

            output += `"${NAME}":{"type": "origins:attribute"${MODIFIERS}${UPDATE_HEALTH}${CONDITIONS}}`;
          }
          block = block.getNextBlock();
        }
        return output;
      }

      output = buildOutput(topBlock).trim()
      console.log(output)
      try {
        if (output) {
          output = eval("(" + output + ")");
          output = JSON.stringify(output, null, 2)
        }
        //console.log(output)
        document.getElementById('outputArea').value = output;
      } catch (error) {
        document.getElementById('outputArea').value = `Meet Error: ${error}\nOutput:\n${output}`;
      }
    }


    workspace.addChangeListener(updateOutput);

    function copyOutput() {
      var outputText = document.getElementById('outputArea');
      outputText.select();
      outputText.setSelectionRange(0, 99999);
      navigator.clipboard.writeText(outputText.value);
    }

    updateOutput();
  </script>
</body>

</html>